version: '3.8'

services:
  # The Gatekeeper: Holds port 3002 and routes traffic
  nginx:
    image: nginx:alpine
    container_name: opsmind-nginx
    ports:
      - "3002:3002"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # Ensure your frontend files are in a folder named 'frontend' next to this file
      - ./frontend:/usr/share/nginx/html:ro
    depends_on:
      - inventory-backend
    networks:
      - opsmind-net

  inventory-backend:
    build: .
    container_name: opsmind-inventory-backend
    restart: always
    expose:
      - "5000"
    environment:
      - PORT=5000
      - NODE_ENV=production
      - MONGO_URI=mongodb://opsmind-mongodb:27017/opsmind_assets
      # Matches the admin user we verified
      - RABBITMQ_URI=amqp://admin:password123@opsmind-rabbitmq:5672
    depends_on:
      - opsmind-rabbitmq
    networks:
      - opsmind-net

  opsmind-rabbitmq:
    image: rabbitmq:3-management
    container_name: opsmind-rabbitmq
    restart: always
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=password123
    networks:
      - opsmind-net

networks:
  opsmind-net:
    external: true
    name: opsmind-net